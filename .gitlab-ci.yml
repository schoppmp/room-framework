variables:
  REGISTRY: gitlab.informatik.hu-berlin.de:4567

build_all:
  image: $REGISTRY/ti/software/bazel-builder:latest
  stage: build
  script:
    - bazel build ...

deploy:
  image: docker:dind
  stage: deploy
  services:
    - docker:dind # Needed until container_push works (https://github.com/google/containerregistry/issues/42)
  script:
    - docker run --rm \
        -e CACHE_USER=$CACHE_USER \
        -e CACHE_PASSWORD=$CACHE_PASSWORD \
        -v /var/run/docker.sock:/var/run/docker.sock \
        -v $PWD:/data $REGISTRY/ti/software/bazel-builder:latest \
        "cd /data && bazel run -c opt //sparse_linear_algebra:all_images"
    - docker images | \
        grep "$REGISTRY/$CI_PROJECT_PATH" | \
        cut -d" " -f1 | \
        while read image; do \
          docker push $image; \
        done