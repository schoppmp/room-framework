extern crate oblivc;
extern crate liback_sys;

// include bindings generated by the build script
pub mod fss_oblivc {
    #![allow(non_snake_case, non_camel_case_types, non_upper_case_globals, unused_variables)]
    include!(concat!(env!("OUT_DIR"), "/benchmark_fss.rs"));
}
use self::fss_oblivc::*;

fn main() {
    static NUM_ITERATIONS: usize = 100; // number of experiments to average the time over
    for len in (10..23).map(|x| 1<<x) {
        println!("Running len = {}", len);
        let len2 = len;
        let server = ::std::thread::spawn(move || {
            let mut args = BenchmarkFSSArgs{
                len: len2,
                num_iterations: NUM_ITERATIONS,
                result_time: 0.
            };
            let pd = oblivc::protocol_desc()
                .party(1)
                .accept(format!("{}", 37845)).unwrap();
            unsafe {
                pd.exec_yao_protocol(benchmark_fss, &mut args);
            }
        });
        let mut args = BenchmarkFSSArgs{
            len: len,
            num_iterations: NUM_ITERATIONS,
            result_time: 0.
        };
        let pd = oblivc::protocol_desc()
            .party(2)
            .connect("localhost", format!("{}", 37845)).unwrap();
        unsafe {
            pd.exec_yao_protocol(benchmark_fss, &mut args);
        }
        server.join().unwrap();
        println!("Time (ms): {}", args.result_time);
    }
}
